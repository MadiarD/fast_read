<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>Оқу Тесті</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- CSRF Token as Hidden Input -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        #text-container {
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: scroll;
            display: none;
            background-color: #ffffff;
        }
        #read-text {
            margin-top: 10px;
            font-style: italic;
            color: #6c757d;
        }
        #timer {
            font-weight: bold;
            margin-top: 10px;
        }
        #questions-container {
            display: none;
            margin-top: 30px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #ced4da;
        }
        .question {
            margin-bottom: 20px;
        }
        .question h5 {
            margin-bottom: 10px;
        }
        #submit-btn {
            margin-top: 20px;
        }
        .progress {
            height: 25px;
            margin-top: 15px;
            display: none;
        }
        #read-text, #timer {
            font-size: 1.1rem;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="mb-4 text-center">Оқу Тесті</h1>

        <!-- Start Button -->
        <div class="text-center">
            <button id="start-btn" class="btn btn-primary btn-lg">Бастау</button>
        </div>

        <!-- Stopwatch Display -->
        <div id="timer" class="text-center text-primary">Уақыт: 0 секунд</div>

        <!-- Progress Bar -->
        <div class="progress" id="progress-bar">
            <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>

        <!-- Text Container -->
        <div id="text-container" class="mt-4">
            <p id="story-text"></p>
        </div>

        <!-- Read Text Display -->
        <div id="read-text" class="text-center">Прочитанный текст: </div>

        <!-- Ready Button -->
        <div class="text-center mt-3">
            <button id="ready-btn" class="btn btn-success" style="display: none;">Дайын</button>
        </div>

        <!-- Questions Container -->
        <div id="questions-container" class="mt-5">
            <h2 class="mb-4">Тест</h2>
            <form id="quiz-form">
                <!-- Questions will be injected here -->
                 <!-- Add this above the Start Button -->
                <div class="mb-3">
                    <label for="tel_number" class="form-label">Телефон номеріңіз:</label>
                    <input type="text" class="form-control" id="tel_number" name="tel_number" required>
                </div>

                <button type="submit" id="submit-btn" class="btn btn-primary">Жіберу</button>
            </form>
        </div>
    </div>

    <!-- Bootstrap JS and Dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Function to get CSRF token from hidden input
        function getCSRFToken() {
            const csrfToken = document.querySelector('[name=csrf-token]').getAttribute('content');
            return csrfToken;
        }

        // Fetch Test Data from the Server
        async function fetchTestData() {
            try {
                const response = await fetch('/get_text_and_questions/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch test data.');
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching test data:', error);
                alert('Тест деректерін жүктеу кезінде қате орын алды.');
            }
        }

        // Initialize the Quiz Form with Questions
        function initializeQuestions(data) {
            data.questions.forEach((q) => {
                let questionHtml = `<div class="question" data-question-id="${q.id}">
                                        <h5>${q.id}. ${q.question}</h5>`;  // Use q.id for the question number
                q.answers.forEach(a => {
                    questionHtml += `<div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_${q.id}" id="q${q.id}_a${a.id}" value="${a.id}" required>
                                        <label class="form-check-label" for="q${q.id}_a${a.id}">
                                            ${a.answer}
                                        </label>
                                     </div>`;
                });
                questionHtml += `</div>`;
                $('#quiz-form').append(questionHtml);
            });
        }
        

        let timerInterval;
        let secondsElapsed = 0;
        let testData = {};

        $(document).ready(function() {
            // Fetch test data from the server
            fetchTestData().then(data => {
                if (data) {
                    testData = data;
                    $('#story-text').text(data.text);
                    initializeQuestions(data);
                }
            });

            // Start Button Click
            $('#start-btn').click(function() {
                $(this).fadeOut();
                $('#text-container').fadeIn();
                $('#ready-btn').fadeIn();
                $('#progress-bar').fadeIn();
                startTimer();
            });

            // Ready Button Click
            $('#ready-btn').click(function() {
                stopTimer();
                let readText = getTextUpToVisible();
                $('#read-text').text('Прочитанный текст: ' + readText);
                $('#text-container').fadeOut();
                $('#ready-btn').fadeOut();
                $('#progress-bar').fadeOut();
                $('#questions-container').fadeIn();
            });

            // Form Submission
            $('#quiz-form').submit(function(event) {
                event.preventDefault();
        
                let answers = {};
        
                // Loop over each question div and get the data-question-id and selected answer
                $('.question').each(function() {
                    let questionId = $(this).data('question-id');  // Correctly retrieve the data-question-id
                    let selectedAnswer = $(this).find('input[type="radio"]:checked').val();
                    
                    if (questionId && selectedAnswer) {
                        answers[parseInt(questionId)] = [parseInt(selectedAnswer)];  // Store the selected answer as a list
                    }
                });

                // Collect telephone number if needed
                // Uncomment the following lines if you add a telephone number input
               
                let tel_number = $('#tel_number').val();
                if (!tel_number) {
                    alert('Телефон номеріңізді енгізіңіз.');
                    return;
                }
        

                // Prepare data to send
                let payload = {
                    id: testData.id,
                    text: testData.text,
                    tel_number: tel_number, // Collect if needed
                    time: secondsElapsed,
                    answers: answers
                };

                // Retrieve CSRF token from hidden input
                const csrfToken = getCSRFToken();

                // Send data to server
                fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken // For Django
                    },
                    body: JSON.stringify(payload),
                    credentials: 'same-origin' // Include cookies
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Жауапты жіберу кезінде қате орын алды.');
                    }
                    return response.json();
                })
                .then(responseData => {
                    // Display success message
                    $('body').html(`
                        <div class="container text-center">
                            <h2 class="mt-5">Рахмет!</h2>
                            <p>Сіздің жауабыңыз қабылданды!</p>
                        </div>
                    `);
                    console.log(responseData);
                })
                .catch(error => {
                    alert('Қате: ' + error.message);
                    console.error('Қате:', error);
                });
            });
        });

        // Timer Functions
        function startTimer() {
            timerInterval = setInterval(() => {
                secondsElapsed++;
                $('#timer').text(`Уақыт: ${secondsElapsed} секунд`);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // Scroll Tracking Functions with Progress Bar
        function getTextUpToVisible() {
            let container = document.getElementById('text-container');
            let textElement = document.getElementById('story-text');

            // Current scroll position
            let scrollTop = container.scrollTop;
            let visibleHeight = container.clientHeight;

            // Total height of the text
            let totalHeight = textElement.scrollHeight;

            // Proportion scrolled
            let percentScrolled = (scrollTop + visibleHeight) / totalHeight;
            percentScrolled = Math.min(percentScrolled, 1); // Ensure it doesn't exceed 1

            // Get full text
            let fullText = textElement.innerText;

            // Calculate number of characters
            let visibleChars = Math.floor(fullText.length * percentScrolled);

            // Update progress bar
            updateProgressBar(percentScrolled * 100);

            // Return the visible part of the text
            return fullText.slice(0, visibleChars);
        }

        // Update progress bar
        function updateProgressBar(percentage) {
            $('.progress-bar').css('width', `${percentage}%`);
            $('.progress-bar').attr('aria-valuenow', percentage);
            $('.progress-bar').text(`${Math.floor(percentage)}%`);
        }

        // Update read text and progress bar on scroll
        $('#text-container').on('scroll', function() {
            let readText = getTextUpToVisible();
            $('#read-text').text('Прочитанный текст: ' + readText);
        });
    </script>

</body>
</html>
